<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Doctor Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .slot-available { border: 2px solid #198754; padding: 6px; border-radius: 8px; }
      .slot-unavailable { border: 2px solid #dc3545; padding: 6px; border-radius: 8px; }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
      <div class="container">
        <span class="navbar-brand">Welcome Dr. {{ doctor_name }}</span>
        <div>
          <a href="/" class="btn btn-outline-secondary btn-sm">Logout</a>
        </div>
      </div>
    </nav>

    <div class="container my-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }} mt-2">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <h5>Upcoming Appointments</h5>
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Sr No.</th>
            <th>Patient Name</th>
            <th>Date</th>
            <th>Time</th>
            <th>Department</th>
            <th>Patient History</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for appt in appointments %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ appt[1] }}</td>
            <td>{{ appt[2] or '' }}</td>
            <td>{{ appt[3] or '' }}</td>
            <td>{{ appt[4] or '' }}</td>
            <td>
              <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#updateModal" data-patient="{{ appt[1] }}">update</button>
            </td>
            <td>
  <form style="display:inline" method="POST" action="{{ url_for('mark_complete', appointment_id=appt[0]) }}">
    <input type="hidden" name="doctor_name" value="{{ doctor_name }}">
    <button class="btn btn-success btn-sm">mark as complete</button>
  </form>

  <form style="display:inline" method="POST" action="{{ url_for('cancel_appointment', appointment_id=appt[0]) }}">
    <input type="hidden" name="doctor_name" value="{{ doctor_name }}">
    <button class="btn btn-danger btn-sm">cancel</button>
  </form>
</td>

          </tr>
          {% else %}
            <tr><td colspan="7" class="text-center">No upcoming appointments</td></tr>
          {% endfor %}
        </tbody>
      </table>

      <h5 class="mt-4">Assigned Patients</h5>
      <div class="list-group">
        {% for p in assigned_patients %}
          <div class="d-flex justify-content-between align-items-center list-group-item">
            <div>{{ p }}</div>
            <div>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#historyModal" data-patient="{{ p }}">view</button>
            </div>
          </div>
        {% else %}
          <div class="list-group-item">No assigned patients</div>
        {% endfor %}
      </div>

      <div class="mt-4 text-end">
        <a href="{{ url_for('provide_availability', doctor_name=doctor_name) }}" class="btn btn-success">Provide Availability</a>
      </div>
    </div>

    <!-- Update Patient History Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form action="{{ url_for('update_patient_history') }}" method="POST" class="p-3">
            <input type="hidden" name="doctor_name" value="{{ doctor_name }}">
            <input type="hidden" name="patient_name" id="modal_patient_name">
            <h5>Update Patient History</h5>

            <div class="row mt-2">
              <div class="col-md-6 mb-2">
                <input type="text" class="form-control" name="visit_type" placeholder="Visit Type">
              </div>
              <div class="col-md-6 mb-2">
                <input type="text" class="form-control" name="test_done" placeholder="Test Done">
              </div>
            </div>

            <div class="mb-2">
              <input type="text" class="form-control" name="diagnosis" placeholder="Diagnosis">
            </div>
            <div class="mb-2">
              <input type="text" class="form-control" name="prescription" placeholder="Prescription">
            </div>
            <div class="mb-2">
              <textarea class="form-control" name="medicines" placeholder="Medicines (e.g. Medicine 1 1-0-1)"></textarea>
            </div>

            <div class="text-end">
              <button class="btn btn-success">save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View Patient History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Patient History</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="historyContent">
            Loading...
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Set patient name into update modal
      var updateModal = document.getElementById('updateModal')
      updateModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        var patient = button.getAttribute('data-patient')
        document.getElementById('modal_patient_name').value = patient
      })

      // Load patient history into view modal via fetch
      var historyModal = document.getElementById('historyModal')
      historyModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        var patient = button.getAttribute('data-patient')
        var content = document.getElementById('historyContent')
        content.innerHTML = 'Loading...'
        fetch('/get_patient_history/' + encodeURIComponent(patient))
          .then(r => r.text())
          .then(html => { content.innerHTML = html })
          .catch(e => { content.innerHTML = '<p>Error loading history</p>' })
      })
    </script>
  </body>
</html>
